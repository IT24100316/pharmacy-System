<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Management Dashboard</title>
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>

<header>Medicine Stock Dashboard</header>

<div class="container">
    <div class="dashboard-buttons">
        <button id="addMedicineBtn">Add Medicine</button>
    </div>

    <div class="inventory-table">
        <h2>Medicines</h2>
        <table id="medicineTable">
            <thead>
            <tr>
                <th>MedicineID</th>
                <th>Name</th>
                <th>Brand</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Expiry Date</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Toast container -->
<div id="toastContainer" class="toast-container"></div>

<!-- Modal -->
<div id="medicineModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Add Medicine</h3>
        <input type="text" id="medicineID" placeholder="Medicine ID">
        <input type="text" id="name" placeholder="Medicine Name">
        <input type="text" id="brand" placeholder="Brand">
        <input type="number" id="price" placeholder="Price">
        <input type="number" id="quantity" placeholder="Quantity">
        <input type="date" id="expiry" placeholder="Expiry Date">
        <button onclick="addMedicine()">Add Medicine</button>
    </div>
</div>

<script>
    const modal = document.getElementById('medicineModal');
    const btn = document.getElementById('addMedicineBtn');
    const span = document.getElementsByClassName('close')[0];
    const medicineTable = document.getElementById('medicineTable').getElementsByTagName('tbody')[0];
    let medicines = [];

    // Open/close modal
    btn.onclick = () => modal.style.display = 'block';
    span.onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; }

    // Fetch medicines on page load
    window.onload = () => {
        fetch('http://localhost:8080/api/medicines')
            .then(res => res.json())
            .then(data => {
                medicines = data;
                renderTable();
            })
            .catch(err => console.error('Error fetching medicines:', err));
    }

    // Show toast function
    function showToast(message, type) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerText = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // Add medicine
    function addMedicine() {
        const medicineID = document.getElementById('medicineID').value.trim();
        const name = document.getElementById('name').value.trim();
        const brand = document.getElementById('brand').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const quantity = parseInt(document.getElementById('quantity').value);
        const expiry = document.getElementById('expiry').value;

        if (!medicineID || !name || !brand || isNaN(price) || isNaN(quantity) || !expiry) {
            showToast('Please fill all fields correctly', 'low');
            return;
        }

        fetch('http://localhost:8080/api/medicines', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ medicineID, name, brand, price, quantity, expiry })
        })
            .then(response => response.json())
            .then(data => {
                medicines.push(data);
                renderTable();
                modal.style.display = 'none';
            })
            .catch(err => console.error('Error adding medicine:', err));

        // Clear inputs
        document.getElementById('medicineID').value = '';
        document.getElementById('name').value = '';
        document.getElementById('brand').value = '';
        document.getElementById('price').value = '';
        document.getElementById('quantity').value = '';
        document.getElementById('expiry').value = '';
    }

    // Render table with updated status
    function renderTable() {
        medicineTable.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];

        medicines.forEach(m => {
            const row = medicineTable.insertRow();
            let statusText = '';
            let statusClass = '';

            if (m.expiry < today) {
                statusText = 'Expired';
                statusClass = 'status-expired';
                showToast(`Medicine "${m.name}" (Brand: ${m.brand}) has expired!`, 'expired');
            } else if (m.quantity === 0) {
                statusText = 'Out of Stock';
                statusClass = 'status-out';
                showToast(`Medicine "${m.name}" (Brand: ${m.brand}) is out of stock!`, 'out');
            } else if (m.quantity <= 5) {
                statusText = 'Low Stock';
                statusClass = 'status-low';
                showToast(`Medicine "${m.name}" (Brand: ${m.brand}) is low in stock!`, 'low');
            } else {
                statusText = 'In Stock';
                statusClass = 'status-in';
            }

            row.innerHTML = `
            <td>${m.medicineID}</td>
            <td>${m.name}</td>
            <td>${m.brand}</td>
            <td>${m.price.toFixed(2)}</td>
            <td>${m.quantity}</td>
            <td>${m.expiry}</td>
            <td class="${statusClass}">${statusText}</td>
        `;
        });
    }

</script>
</body>
</html>
